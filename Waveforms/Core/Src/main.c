/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * <h2><center>&copy; Copyright (c) 2021 STMicroelectronics.
  * All rights reserved.</center></h2>
  *
  * This software component is licensed by ST under BSD 3-Clause license,
  * the "License"; You may not use this file except in compliance with the
  * License. You may obtain a copy of the License at:
  *                        opensource.org/licenses/BSD-3-Clause
  *
  ******************************************************************************
  */
/* USER CODE END Header */
/* Includes ------------------------------------------------------------------*/
#include "main.h"
#include "adc.h"
#include "dac.h"
#include "dma.h"
#include "tim.h"
#include "gpio.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include <math.h>
/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */

//#define NS 1024

//#define FULLBUFFERSIZE 2048

/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */

/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/

/* USER CODE BEGIN PV */

// DAC Buffer of 2 Wavelength Size
uint32_t dac_val[FULLBUFFERSIZE];

volatile uint32_t* outBufPtr = NULL;
volatile uint32_t* inBufPtr = NULL;

bool keyPressFlag = false;

uint8_t oscType = 0;

float waveAmp = 0.8;
uint16_t volume = 0;

bool keyState[7] = {true, true, true, true, true, true, true};

uint32_t Sine_LUT[NS] = {
		2049, 2074, 2099, 2124, 2149, 2174, 2199, 2225, 2250, 2275, 2300, 2325, 2350, 2375, 2399,
		2424, 2449, 2474, 2498, 2523, 2547, 2572, 2596, 2620, 2644, 2668, 2692, 2716, 2740, 2764,
		2787, 2811, 2834, 2857, 2880, 2903, 2926, 2949, 2971, 2994, 3016, 3038, 3060, 3082, 3103,
		3125, 3146, 3168, 3189, 3209, 3230, 3251, 3271, 3291, 3311, 3331, 3350, 3370, 3389, 3408,
		3426, 3445, 3463, 3481, 3499, 3517, 3534, 3552, 3569, 3585, 3602, 3618, 3634, 3650, 3666,
		3681, 3696, 3711, 3726, 3740, 3754, 3768, 3781, 3795, 3808, 3820, 3833, 3845, 3857, 3869,
		3880, 3891, 3902, 3913, 3923, 3933, 3943, 3952, 3961, 3970, 3979, 3987, 3995, 4003, 4010,
		4017, 4024, 4031, 4037, 4043, 4048, 4054, 4059, 4063, 4068, 4072, 4076, 4079, 4082, 4085,
		4088, 4090, 4092, 4094, 4095, 4096, 4097, 4097, 4097, 4097, 4096, 4095, 4094, 4093, 4091,
		4089, 4086, 4084, 4081, 4077, 4074, 4070, 4066, 4061, 4056, 4051, 4046, 4040, 4034, 4027,
		4021, 4014, 4007, 3999, 3991, 3983, 3975, 3966, 3957, 3948, 3938, 3928, 3918, 3908, 3897,
		3886, 3875, 3863, 3851, 3839, 3827, 3814, 3801, 3788, 3775, 3761, 3747, 3733, 3718, 3704,
		3689, 3673, 3658, 3642, 3626, 3610, 3594, 3577, 3560, 3543, 3526, 3508, 3490, 3472, 3454,
		3436, 3417, 3398, 3379, 3360, 3340, 3321, 3301, 3281, 3261, 3240, 3220, 3199, 3178, 3157,
		3136, 3114, 3093, 3071, 3049, 3027, 3005, 2982, 2960, 2937, 2915, 2892, 2869, 2845, 2822,
		2799, 2775, 2752, 2728, 2704, 2680, 2656, 2632, 2608, 2584, 2559, 2535, 2510, 2486, 2461,
		2437, 2412, 2387, 2362, 2337, 2312, 2287, 2262, 2237, 2212, 2187, 2162, 2137, 2111, 2086,
		2061, 2036, 2011, 1986, 1960, 1935, 1910, 1885, 1860, 1835, 1810, 1785, 1760, 1735, 1710,
		1685, 1660, 1636, 1611, 1587, 1562, 1538, 1513, 1489, 1465, 1441, 1417, 1393, 1369, 1345,
		1322, 1298, 1275, 1252, 1228, 1205, 1182, 1160, 1137, 1115, 1092, 1070, 1048, 1026, 1004,
		983, 961, 940, 919, 898, 877, 857, 836, 816, 796, 776, 757, 737, 718, 699,
		680, 661, 643, 625, 607, 589, 571, 554, 537, 520, 503, 487, 471, 455, 439,
		424, 408, 393, 379, 364, 350, 336, 322, 309, 296, 283, 270, 258, 246, 234,
		222, 211, 200, 189, 179, 169, 159, 149, 140, 131, 122, 114, 106, 98, 90,
		83, 76, 70, 63, 57, 51, 46, 41, 36, 31, 27, 23, 20, 16, 13,
		11, 8, 6, 4, 3, 2, 1, 0, 0, 0, 0, 1, 2, 3, 5,
		7, 9, 12, 15, 18, 21, 25, 29, 34, 38, 43, 49, 54, 60, 66,
		73, 80, 87, 94, 102, 110, 118, 127, 136, 145, 154, 164, 174, 184, 195,
		206, 217, 228, 240, 252, 264, 277, 289, 302, 316, 329, 343, 357, 371, 386,
		401, 416, 431, 447, 463, 479, 495, 512, 528, 545, 563, 580, 598, 616, 634,
		652, 671, 689, 708, 727, 747, 766, 786, 806, 826, 846, 867, 888, 908, 929,
		951, 972, 994, 1015, 1037, 1059, 1081, 1103, 1126, 1148, 1171, 1194, 1217, 1240, 1263,
		1286, 1310, 1333, 1357, 1381, 1405, 1429, 1453, 1477, 1501, 1525, 1550, 1574, 1599, 1623,
		1648, 1673, 1698, 1722, 1747, 1772, 1797, 1822, 1847, 1872, 1898, 1923, 1948, 1973, 1998,
		2023, 2048,
};



//uint32_t Tri_LUT[NS] = {
//		2048, 2055, 2063, 2071, 2079, 2088, 2096, 2104, 2112, 2120, 2128, 2136, 2143, 2151, 2160,
//		2168, 2176, 2184, 2192, 2200, 2208, 2216, 2224, 2232, 2240, 2248, 2256, 2264, 2272, 2280,
//		2288, 2296, 2304, 2312, 2320, 2328, 2336, 2344, 2352, 2360, 2368, 2376, 2384, 2392, 2400,
//		2408, 2416, 2424, 2432, 2440, 2448, 2456, 2464, 2472, 2480, 2488, 2496, 2504, 2512, 2520,
//		2528, 2536, 2544, 2552, 2560, 2568, 2576, 2584, 2592, 2600, 2608, 2616, 2624, 2632, 2640,
//		2648, 2656, 2664, 2672, 2680, 2688, 2696, 2704, 2712, 2720, 2728, 2736, 2744, 2752, 2760,
//		2768, 2776, 2784, 2792, 2800, 2808, 2816, 2824, 2832, 2840, 2848, 2856, 2864, 2872, 2880,
//		2888, 2896, 2904, 2912, 2920, 2928, 2936, 2944, 2952, 2960, 2968, 2976, 2984, 2992, 3000,
//		3008, 3016, 3024, 3032, 3040, 3048, 3056, 3064, 3072, 3080, 3088, 3096, 3104, 3112, 3120,
//		3128, 3136, 3144, 3152, 3160, 3168, 3176, 3184, 3192, 3200, 3208, 3216, 3224, 3232, 3240,
//		3248, 3257, 3264, 3272, 3280, 3288, 3296, 3304, 3312, 3320, 3329, 3337, 3345, 3353, 3360,
//		3368, 3376, 3384, 3392, 3401, 3409, 3417, 3425, 3433, 3441, 3448, 3456, 3464, 3472, 3481,
//		3489, 3497, 3505, 3513, 3521, 3528, 3536, 3544, 3552, 3561, 3569, 3577, 3585, 3593, 3601,
//		3609, 3616, 3624, 3632, 3641, 3649, 3657, 3665, 3673, 3681, 3689, 3696, 3704, 3712, 3721,
//		3729, 3737, 3745, 3753, 3761, 3769, 3777, 3784, 3792, 3801, 3809, 3817, 3825, 3833, 3841,
//		3849, 3857, 3864, 3872, 3881, 3889, 3897, 3905, 3913, 3921, 3929, 3937, 3944, 3952, 3960,
//		3969, 3977, 3986, 3994, 4002, 4009, 4016, 4024, 4031, 4040, 4049, 4058, 4068, 4076, 4082,
//		4086, 4087, 4084, 4079, 4072, 4063, 4054, 4044, 4036, 4027, 4020, 4013, 4005, 3998, 3990,
//		3982, 3973, 3965, 3956, 3948, 3940, 3933, 3925, 3917, 3909, 3901, 3893, 3885, 3876, 3868,
//		3860, 3853, 3845, 3837, 3829, 3821, 3813, 3805, 3797, 3788, 3780, 3773, 3765, 3757, 3749,
//		3741, 3733, 3725, 3717, 3708, 3700, 3693, 3685, 3677, 3669, 3661, 3653, 3645, 3637, 3628,
//		3620, 3612, 3605, 3597, 3589, 3581, 3573, 3565, 3557, 3548, 3540, 3532, 3525, 3517, 3509,
//		3501, 3493, 3485, 3476, 3468, 3460, 3452, 3444, 3437, 3429, 3421, 3413, 3405, 3396, 3388,
//		3380, 3372, 3364, 3356, 3349, 3341, 3333, 3325, 3316, 3308, 3300, 3292, 3284, 3276, 3268,
//		3261, 3253, 3244, 3236, 3228, 3220, 3212, 3204, 3196, 3188, 3180, 3172, 3164, 3156, 3148,
//		3140, 3132, 3124, 3116, 3108, 3100, 3092, 3084, 3076, 3068, 3060, 3052, 3044, 3036, 3028,
//		3020, 3012, 3004, 2996, 2988, 2980, 2972, 2964, 2956, 2948, 2940, 2932, 2924, 2916, 2908,
//		2900, 2892, 2884, 2876, 2868, 2860, 2852, 2844, 2836, 2828, 2820, 2812, 2804, 2796, 2788,
//		2780, 2772, 2764, 2756, 2748, 2740, 2732, 2724, 2716, 2708, 2700, 2692, 2684, 2676, 2668,
//		2660, 2652, 2644, 2636, 2628, 2620, 2612, 2604, 2596, 2588, 2580, 2572, 2564, 2556, 2548,
//		2540, 2532, 2524, 2516, 2508, 2500, 2492, 2484, 2476, 2468, 2460, 2452, 2444, 2436, 2428,
//		2420, 2412, 2404, 2396, 2388, 2380, 2372, 2364, 2356, 2348, 2340, 2332, 2324, 2316, 2308,
//		2300, 2292, 2284, 2276, 2268, 2260, 2252, 2244, 2236, 2228, 2220, 2212, 2204, 2196, 2188,
//		2180, 2172, 2164, 2156, 2147, 2140, 2132, 2124, 2116, 2108, 2100, 2092, 2083, 2075, 2067,
//		2059, 2051, 2044, 2036, 2028, 2020, 2012, 2003, 1995, 1987, 1979, 1971, 1963, 1955, 1948,
//		1939, 1931, 1923, 1915, 1907, 1899, 1891, 1883, 1875, 1867, 1859, 1851, 1843, 1835, 1827,
//		1819, 1811, 1803, 1795, 1787, 1779, 1771, 1763, 1755, 1747, 1739, 1731, 1723, 1715, 1707,
//		1699, 1691, 1683, 1675, 1667, 1659, 1651, 1643, 1635, 1627, 1619, 1611, 1603, 1595, 1587,
//		1579, 1571, 1563, 1555, 1547, 1539, 1531, 1523, 1515, 1507, 1499, 1491, 1483, 1475, 1467,
//		1459, 1451, 1443, 1435, 1427, 1419, 1411, 1403, 1395, 1387, 1379, 1371, 1363, 1355, 1347,
//		1339, 1331, 1323, 1315, 1307, 1299, 1291, 1283, 1275, 1267, 1259, 1251, 1243, 1235, 1227,
//		1219, 1211, 1203, 1195, 1187, 1179, 1171, 1163, 1155, 1147, 1139, 1131, 1123, 1115, 1107,
//		1099, 1091, 1083, 1075, 1067, 1059, 1051, 1043, 1035, 1027, 1019, 1011, 1003, 995, 987,
//		979, 971, 963, 955, 947, 939, 931, 923, 915, 907, 899, 891, 883, 875, 867,
//		859, 851, 842, 834, 827, 819, 811, 803, 795, 787, 779, 770, 762, 754, 746,
//		739, 731, 723, 715, 707, 699, 690, 682, 674, 666, 658, 651, 643, 635, 627,
//		619, 610, 602, 594, 586, 578, 570, 563, 555, 547, 538, 530, 522, 514, 506,
//		498, 490, 483, 475, 467, 458, 450, 442, 434, 426, 418, 410, 402, 395, 387,
//		378, 370, 362, 354, 346, 338, 330, 322, 315, 307, 298, 290, 282, 274, 266,
//		258, 250, 242, 235, 227, 219, 210, 202, 194, 186, 178, 170, 162, 155, 147,
//		139, 130, 122, 113, 105, 97, 90, 82, 75, 68, 59, 51, 41, 32, 23,
//		16, 11, 8, 9, 13, 19, 27, 37, 46, 55, 64, 71, 79, 86, 93,
//		101, 109, 118, 126, 135, 143, 151, 158, 166, 174, 182, 190, 198, 206, 214,
//		223, 231, 238, 246, 254, 262, 270, 278, 286, 294, 303, 311, 318, 326, 334,
//		342, 350, 358, 366, 374, 383, 391, 399, 406, 414, 422, 430, 438, 446, 454,
//		463, 471, 479, 486, 494, 502, 510, 518, 526, 534, 543, 551, 559, 567, 574,
//		582, 590, 598, 606, 614, 623, 631, 639, 647, 654, 662, 670, 678, 686, 694,
//		703, 711, 719, 727, 735, 742, 750, 758, 766, 775, 783, 791, 799, 807, 815,
//		823, 831, 838, 847, 855, 863, 871, 879, 887, 895, 903, 911, 919, 927, 935,
//		943, 951, 959, 967, 975, 983, 991, 999, 1007, 1015, 1023, 1031, 1039, 1047, 1055,
//		1063, 1071, 1079, 1087, 1095, 1103, 1111, 1119, 1127, 1135, 1143, 1151, 1159, 1167, 1175,
//		1183, 1191, 1199, 1207, 1215, 1223, 1231, 1239, 1247, 1255, 1263, 1271, 1279, 1287, 1295,
//		1303, 1311, 1319, 1327, 1335, 1343, 1351, 1359, 1367, 1375, 1383, 1391, 1399, 1407, 1415,
//		1423, 1431, 1439, 1447, 1455, 1463, 1471, 1479, 1487, 1495, 1503, 1511, 1519, 1527, 1535,
//		1543, 1551, 1559, 1567, 1575, 1583, 1591, 1599, 1607, 1615, 1623, 1631, 1639, 1647, 1655,
//		1663, 1671, 1679, 1687, 1695, 1703, 1711, 1719, 1727, 1735, 1743, 1751, 1759, 1767, 1775,
//		1783, 1791, 1799, 1807, 1815, 1823, 1831, 1839, 1847, 1855, 1863, 1871, 1879, 1887, 1895,
//		1903, 1911, 1919, 1927, 1935, 1944, 1952, 1959, 1967, 1975, 1983, 1991, 1999, 2007, 2016,
//		2024, 2032, 2040, 2048,
//};

//uint32_t Sqr_LUT[NS] = {
//		2048, -17346, -33196, -42821, -45033, -40352, -30782, -19203, -8571, -1162, 1942, 988, -2687, -7187, -10685,
//		-11963, -10708, -7497, -3506, -56, 1837, 1771, 40, -2532, -4908, -6212, -6011, -4431, -2071, 238,
//		1733, 1985, 1024, -700, -2498, -3697, -3875, -2993, -1393, 349, 1631, 2044, 1506, 273, -1164,
//		-2263, -2628, -2141, -994, 393, 1532, 2039, 1771, 868, -312, -1321, -1792, -1563, -726, 409,
//		1436, 1999, 1922, 1261, 281, -647, -1182, -1134, -527, 412, 1343, 1940, 2004, 1532, 715,
//		-136, -708, -794, -368, 409, 1255, 1870, 2041, 1723, 1046, 268, -323, -511, -234, 406,
//		1172, 1792, 2046, 1856, 1302, 596, 0, -268, -113, 404, 1095, 1709, 2029, 1947, 1504,
//		869, 278, -52, -2, 407, 1023, 1623, 1994, 2005, 1663, 1097, 521, 144, 105, 414,
//		957, 1537, 1945, 2037, 1787, 1291, 735, 325, 208, 427, 899, 1452, 1886, 2047, 1882,
//		1455, 927, 493, 311, 446, 847, 1368, 1820, 2040, 1953, 1594, 1100, 651, 413, 471,
//		803, 1287, 1747, 2017, 2002, 1712, 1255, 800, 515, 502, 766, 1209, 1669, 1981, 2033,
//		1809, 1394, 941, 617, 540, 737, 1135, 1589, 1934, 2046, 1888, 1518, 1075, 721, 585,
//		716, 1066, 1506, 1877, 2045, 1950, 1629, 1201, 824, 635, 703, 1002, 1423, 1813, 2029,
//		1996, 1726, 1320, 927, 691, 698, 945, 1341, 1741, 2001, 2027, 1810, 1431, 1030, 753,
//		701, 893, 1259, 1664, 1962, 2044, 1881, 1535, 1132, 820, 712, 849, 1179, 1582, 1912,
//		2047, 1940, 1631, 1232, 891, 731, 812, 1102, 1497, 1852, 2037, 1986, 1718, 1331, 966,
//		758, 782, 1029, 1409, 1783, 2014, 2019, 1796, 1426, 1045, 792, 760, 960, 1319, 1706,
//		1980, 2040, 1865, 1518, 1127, 833, 746, 895, 1228, 1622, 1933, 2047, 1923, 1606, 1210,
//		881, 739, 836, 1136, 1531, 1874, 2042, 1972, 1688, 1295, 936, 741, 783, 1046, 1434,
//		1805, 2023, 2009, 1765, 1381, 996, 751, 736, 956, 1331, 1724, 1991, 2034, 1835, 1466,
//		1062, 769, 696, 868, 1224, 1633, 1946, 2046, 1897, 1550, 1132, 795, 662, 782, 1112,
//		1531, 1886, 2045, 1950, 1632, 1207, 829, 636, 699, 996, 1419, 1811, 2030, 1992, 1710,
//		1285, 870, 618, 620, 877, 1295, 1722, 1999, 2024, 1784, 1365, 919, 607, 544, 754,
//		1161, 1616, 1952, 2043, 1853, 1448, 974, 604, 472, 628, 1016, 1494, 1886, 2047, 1914,
//		1531, 1036, 608, 403, 498, 858, 1353, 1801, 2035, 1966, 1614, 1104, 620, 339, 364,
//		687, 1192, 1693, 2004, 2007, 1695, 1178, 640, 278, 224, 501, 1007, 1559, 1951, 2035,
//		1774, 1257, 668, 220, 78, 296, 796, 1396, 1873, 2047, 1848, 1340, 702, 164, -76,
//		70, 553, 1196, 1763, 2039, 1915, 1427, 743, 110, -243, -184, 269, 952, 1614, 2006,
//		1973, 1516, 790, 53, -428, -475, -67, 651, 1415, 1939, 2018, 1608, 843, -8, -639,
//		-818, -473, 273, 1149, 1827, 2044, 1700, 901, -79, -890, -1234, -980, -213, 788, 1652,
//		2043, 1792, 961, -171, -1205, -1765, -1640, -864, 285, 1380, 1999, 1880, 1022, -299, -1627,
//		-2485, -2552, -1786, -455, 949, 1885, 1960, 1079, -500, -2250, -3553, -3926, -3207, -1635, 217,
//		1637, 2024, 1124, -857, -3298, -5365, -6305, -5734, -3807, -1205, 1072, 2046, 1126, -1638, -5514,
//		-9283, -11634, -11643, -9157, -4957, -622, 1909, 943, -4364, -13603, -25051, -36010, -43457, -44861, -38901,
//		-25911, -7881, 11976, 30006, 42996, 48956, 47552, 40105, 29146, 17698, 8459, 3152, 2186, 4717, 9052,
//		13252, 15738, 15729, 13378, 9609, 5733, 2969, 2049, 3023, 5300, 7902, 9829, 10400, 9460, 7393,
//		4952, 2971, 2071, 2458, 3878, 5730, 7302, 8021, 7648, 6345, 4595, 3016, 2135, 2210, 3146,
//		4550, 5881, 6647, 6580, 5722, 4394, 3073, 2215, 2096, 2715, 3810, 4959, 5735, 5860, 5300,
//		4266, 3134, 2303, 2052, 2443, 3307, 4308, 5075, 5329, 4985, 4174, 3194, 2395, 2051, 2268,
//		2946, 3822, 4568, 4913, 4734, 4103, 3252, 2487, 2077, 2156, 2680, 3444, 4162, 4570, 4523,
//		4042, 3305, 2579, 2122, 2089, 2481, 3143, 3826, 4279, 4338, 3985, 3352, 2668, 2180, 2056,
//		2332, 2899, 3542, 4025, 4171, 3931, 3393, 2755, 2247, 2048, 2222, 2699, 3299, 3799, 4017,
//		3875, 3427, 2838, 2321, 2060, 2144, 2536, 3088, 3594, 3871, 3817, 3455, 2917, 2400, 2088,
//		2091, 2402, 2903, 3408, 3731, 3756, 3475, 2991, 2481, 2129, 2060, 2294, 2742, 3237, 3597,
//		3692, 3487, 3059, 2564, 2181, 2048, 2209, 2601, 3079, 3467, 3623, 3491, 3121, 2647, 2242,
//		2052, 2143, 2479, 2934, 3341, 3551, 3488, 3176, 2730, 2311, 2071, 2096, 2373, 2800, 3218,
//		3475, 3477, 3225, 2810, 2385, 2103, 2065, 2284, 2676, 3099, 3396, 3459, 3266, 2888, 2463,
//		2145, 2050, 2209, 2564, 2983, 3313, 3433, 3300, 2963, 2545, 2198, 2049, 2149, 2462, 2871,
//		3227, 3399, 3326, 3033, 2629, 2260, 2061, 2104, 2371, 2764, 3139, 3359, 3344, 3099, 2714,
//		2330, 2086, 2072, 2290, 2661, 3049, 3312, 3354, 3159, 2800, 2407, 2123, 2053, 2221, 2564,
//		2959, 3259, 3356, 3214, 2885, 2489, 2172, 2048, 2162, 2473, 2867, 3200, 3349, 3262, 2968,
//		2577, 2230, 2055, 2115, 2389, 2776, 3135, 3335, 3303, 3050, 2669, 2299, 2076, 2081, 2312,
//		2686, 3066, 3313, 3337, 3129, 2764, 2377, 2109, 2058, 2243, 2598, 2993, 3283, 3364, 3204,
//		2863, 2464, 2155, 2048, 2183, 2513, 2916, 3246, 3383, 3275, 2963, 2560, 2214, 2051, 2133,
//		2431, 2836, 3202, 3394, 3342, 3065, 2664, 2285, 2068, 2094, 2354, 2754, 3150, 3397, 3404,
//		3168, 2775, 2369, 2099, 2066, 2282, 2672, 3093, 3392, 3460, 3271, 2894, 2466, 2145, 2050,
//		2218, 2589, 3029, 3379, 3510, 3374, 3020, 2577, 2207, 2049, 2161, 2506, 2960, 3358, 3555,
//		3478, 3154, 2701, 2286, 2062, 2114, 2426, 2886, 3329, 3593, 3580, 3295, 2840, 2383, 2093,
//		2078, 2348, 2808, 3292, 3624, 3682, 3444, 2995, 2501, 2142, 2055, 2275, 2727, 3248, 3649,
//		3784, 3602, 3168, 2640, 2213, 2048, 2209, 2643, 3196, 3668, 3887, 3770, 3360, 2804, 2308,
//		2058, 2150, 2558, 3138, 3681, 3990, 3951, 3574, 2998, 2432, 2090, 2101, 2472, 3072, 3688,
//		4097, 4147, 3817, 3226, 2591, 2148, 2066, 2386, 3000, 3691, 4208, 4363, 4095, 3499, 2793,
//		2239, 2049, 2303, 2923, 3689, 4329, 4606, 4418, 3827, 3049, 2372, 2054, 2225, 2840, 3686,
//		4463, 4889, 4803, 4231, 3380, 2563, 2091, 2155, 2752, 3683, 4622, 5229, 5277, 4742, 3814,
//		2834, 2173, 2096, 2659, 3686, 4821, 5658, 5887, 5416, 4407, 3227, 2324, 2056, 2563, 3702,
//		5089, 6236, 6723, 6358, 5259, 3822, 2589, 2051, 2464, 3746, 5488, 7088, 7970, 7792, 6593,
//		4795, 3071, 2110, 2362, 3857, 6166, 8526, 10106, 10307, 9003, 6627, 4055, 2324, 2258, 4151,
//		7601, 11592, 14803, 16058, 14780, 11282, 6782, 3107, 2153, 5257, 12666, 23298, 34877, 44447, 49128,
//		46916, 37291, 21441, 2048,
//};

//uint32_t Saw_LUT[NS] = {
//		3071, 3071, 3072, 3072, 3073, 3075, 3077, 3080, 3083, 3087, 3091, 3095, 3099, 3102, 3105,
//		3108, 3110, 3111, 3111, 3112, 3112, 3112, 3112, 3112, 3113, 3115, 3117, 3120, 3123, 3127,
//		3131, 3135, 3138, 3142, 3145, 3148, 3150, 3151, 3152, 3152, 3152, 3152, 3152, 3153, 3154,
//		3155, 3157, 3159, 3163, 3166, 3170, 3174, 3178, 3182, 3185, 3188, 3190, 3191, 3192, 3193,
//		3193, 3193, 3193, 3193, 3194, 3195, 3197, 3199, 3202, 3206, 3210, 3214, 3218, 3221, 3225,
//		3228, 3230, 3232, 3233, 3233, 3233, 3233, 3233, 3234, 3234, 3235, 3237, 3239, 3242, 3245,
//		3249, 3253, 3257, 3261, 3265, 3268, 3270, 3272, 3273, 3274, 3274, 3274, 3274, 3274, 3274,
//		3275, 3277, 3279, 3281, 3285, 3289, 3293, 3297, 3301, 3304, 3308, 3310, 3312, 3314, 3314,
//		3315, 3315, 3314, 3314, 3315, 3315, 3317, 3319, 3321, 3324, 3328, 3332, 3336, 3340, 3344,
//		3348, 3350, 3352, 3354, 3355, 3355, 3355, 3355, 3355, 3355, 3355, 3357, 3358, 3361, 3364,
//		3367, 3371, 3376, 3380, 3384, 3387, 3390, 3393, 3394, 3395, 3396, 3396, 3396, 3395, 3395,
//		3396, 3397, 3398, 3400, 3403, 3407, 3411, 3415, 3419, 3424, 3427, 3430, 3433, 3435, 3436,
//		3436, 3436, 3436, 3436, 3436, 3436, 3437, 3438, 3440, 3443, 3446, 3450, 3455, 3459, 3463,
//		3467, 3471, 3473, 3475, 3477, 3477, 3477, 3477, 3476, 3476, 3476, 3477, 3478, 3480, 3482,
//		3486, 3490, 3494, 3498, 3503, 3507, 3511, 3514, 3516, 3517, 3518, 3518, 3518, 3517, 3517,
//		3516, 3517, 3517, 3519, 3522, 3525, 3529, 3533, 3538, 3542, 3547, 3551, 3554, 3556, 3558,
//		3559, 3559, 3558, 3558, 3557, 3557, 3557, 3557, 3559, 3561, 3564, 3568, 3572, 3577, 3582,
//		3586, 3591, 3594, 3597, 3599, 3600, 3600, 3599, 3599, 3598, 3597, 3597, 3597, 3598, 3600,
//		3603, 3607, 3611, 3616, 3621, 3626, 3631, 3634, 3637, 3639, 3640, 3641, 3640, 3639, 3638,
//		3637, 3637, 3637, 3638, 3640, 3642, 3646, 3650, 3655, 3661, 3666, 3671, 3675, 3678, 3680,
//		3682, 3682, 3681, 3680, 3679, 3678, 3677, 3677, 3677, 3679, 3681, 3685, 3689, 3694, 3700,
//		3705, 3711, 3715, 3719, 3721, 3723, 3723, 3723, 3722, 3720, 3718, 3717, 3716, 3716, 3718,
//		3720, 3723, 3728, 3733, 3739, 3745, 3750, 3755, 3759, 3762, 3764, 3765, 3764, 3763, 3761,
//		3759, 3757, 3756, 3756, 3756, 3758, 3762, 3766, 3772, 3778, 3784, 3790, 3796, 3800, 3804,
//		3806, 3807, 3806, 3805, 3802, 3800, 3797, 3795, 3795, 3795, 3797, 3800, 3804, 3810, 3816,
//		3823, 3830, 3836, 3842, 3846, 3848, 3849, 3849, 3847, 3844, 3841, 3838, 3835, 3833, 3833,
//		3834, 3837, 3842, 3848, 3855, 3862, 3870, 3877, 3883, 3888, 3891, 3892, 3892, 3890, 3886,
//		3882, 3878, 3874, 3872, 3870, 3871, 3873, 3878, 3884, 3892, 3901, 3910, 3918, 3925, 3931,
//		3935, 3937, 3936, 3934, 3929, 3924, 3918, 3913, 3909, 3906, 3906, 3908, 3913, 3920, 3928,
//		3938, 3949, 3959, 3969, 3976, 3981, 3983, 3983, 3980, 3974, 3967, 3959, 3951, 3945, 3940,
//		3938, 3939, 3944, 3952, 3962, 3975, 3988, 4002, 4014, 4025, 4032, 4035, 4035, 4030, 4022,
//		4012, 4000, 3987, 3976, 3968, 3963, 3963, 3967, 3977, 3991, 4008, 4028, 4049, 4068, 4084,
//		4096, 4102, 4101, 4094, 4080, 4061, 4039, 4015, 3992, 3973, 3960, 3955, 3959, 3974, 4000,
//		4034, 4075, 4121, 4166, 4207, 4238, 4256, 4255, 4232, 4184, 4109, 4007, 3879, 3727, 3555,
//		3368, 3171, 2971, 2775, 2587, 2415, 2263, 2135, 2033, 1958, 1910, 1887, 1887, 1904, 1936,
//		1977, 2022, 2067, 2108, 2143, 2168, 2183, 2188, 2183, 2170, 2150, 2128, 2104, 2081, 2062,
//		2049, 2041, 2041, 2047, 2058, 2075, 2094, 2114, 2134, 2152, 2166, 2175, 2180, 2180, 2175,
//		2166, 2155, 2143, 2131, 2120, 2112, 2108, 2107, 2111, 2118, 2128, 2140, 2154, 2168, 2180,
//		2191, 2198, 2203, 2204, 2202, 2198, 2191, 2183, 2176, 2168, 2163, 2160, 2159, 2161, 2166,
//		2174, 2183, 2193, 2204, 2214, 2223, 2230, 2234, 2236, 2236, 2234, 2229, 2224, 2218, 2213,
//		2209, 2206, 2206, 2207, 2211, 2217, 2225, 2233, 2242, 2250, 2258, 2264, 2269, 2272, 2272,
//		2271, 2268, 2265, 2260, 2256, 2253, 2251, 2250, 2251, 2255, 2259, 2265, 2273, 2280, 2288,
//		2295, 2301, 2305, 2308, 2310, 2309, 2308, 2305, 2302, 2298, 2296, 2294, 2293, 2294, 2297,
//		2301, 2306, 2312, 2319, 2326, 2333, 2338, 2343, 2346, 2348, 2348, 2347, 2345, 2343, 2340,
//		2338, 2336, 2336, 2337, 2339, 2342, 2347, 2352, 2358, 2365, 2371, 2376, 2381, 2384, 2386,
//		2387, 2387, 2385, 2384, 2381, 2380, 2378, 2378, 2378, 2380, 2383, 2387, 2392, 2398, 2404,
//		2409, 2415, 2419, 2423, 2425, 2426, 2426, 2426, 2424, 2423, 2421, 2420, 2419, 2420, 2421,
//		2424, 2427, 2432, 2437, 2443, 2448, 2453, 2458, 2461, 2464, 2465, 2466, 2466, 2465, 2463,
//		2462, 2461, 2461, 2461, 2462, 2465, 2468, 2472, 2477, 2482, 2487, 2492, 2496, 2500, 2503,
//		2505, 2506, 2506, 2505, 2504, 2503, 2502, 2502, 2502, 2503, 2505, 2508, 2512, 2516, 2521,
//		2526, 2531, 2535, 2539, 2542, 2544, 2545, 2546, 2546, 2545, 2544, 2543, 2543, 2543, 2544,
//		2546, 2548, 2552, 2556, 2561, 2565, 2570, 2575, 2578, 2581, 2584, 2585, 2586, 2586, 2585,
//		2585, 2584, 2584, 2584, 2585, 2586, 2589, 2592, 2596, 2600, 2605, 2609, 2614, 2618, 2621,
//		2623, 2625, 2626, 2626, 2626, 2625, 2625, 2625, 2625, 2625, 2627, 2629, 2632, 2636, 2640,
//		2644, 2649, 2653, 2657, 2660, 2663, 2665, 2666, 2666, 2666, 2666, 2666, 2665, 2665, 2666,
//		2667, 2669, 2672, 2675, 2679, 2684, 2688, 2692, 2696, 2700, 2703, 2705, 2706, 2707, 2707,
//		2707, 2706, 2706, 2706, 2707, 2708, 2709, 2712, 2715, 2719, 2723, 2727, 2732, 2736, 2739,
//		2742, 2744, 2746, 2747, 2747, 2747, 2747, 2747, 2747, 2747, 2748, 2750, 2752, 2755, 2759,
//		2763, 2767, 2771, 2775, 2779, 2782, 2784, 2786, 2787, 2788, 2788, 2788, 2787, 2787, 2788,
//		2789, 2790, 2792, 2795, 2798, 2802, 2806, 2810, 2815, 2818, 2821, 2824, 2826, 2827, 2828,
//		2828, 2828, 2828, 2828, 2828, 2829, 2830, 2832, 2835, 2838, 2842, 2846, 2850, 2854, 2858,
//		2861, 2864, 2866, 2867, 2868, 2869, 2869, 2869, 2868, 2869, 2869, 2871, 2872, 2875, 2878,
//		2881, 2885, 2889, 2893, 2897, 2901, 2904, 2906, 2907, 2908, 2909, 2909, 2909, 2909, 2909,
//		2910, 2911, 2913, 2915, 2918, 2921, 2925, 2929, 2933, 2937, 2940, 2943, 2946, 2948, 2949,
//		2949, 2950, 2950, 2950, 2950, 2950, 2951, 2953, 2955, 2958, 2961, 2964, 2968, 2972, 2976,
//		2980, 2983, 2986, 2988, 2989, 2990, 2990, 2990, 2990, 2990, 2991, 2991, 2993, 2995, 2997,
//		3000, 3004, 3008, 3012, 3016, 3020, 3023, 3026, 3028, 3029, 3030, 3031, 3031, 3031, 3031,
//		3031, 3032, 3033, 3035, 3037, 3040, 3044, 3048, 3051, 3055, 3059, 3063, 3065, 3068, 3069,
//		3070, 3071, 3071, 3071,
//};

/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
/* USER CODE BEGIN PFP */
void processDSP(void);
/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */

/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{
  /* USER CODE BEGIN 1 */

  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_DMA_Init();
  MX_DAC_Init();
  MX_TIM2_Init();
  MX_ADC1_Init();
  /* USER CODE BEGIN 2 */
  HAL_DAC_Start_DMA(&hdac, DAC_CHANNEL_1, (uint32_t*) dac_val, NS, DAC_ALIGN_12B_R);
  HAL_TIM_Base_Start(&htim2);
  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  while (1)
  {
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */

	  if(keyPressFlag) {
		  processDSP();
	  }
  }
  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};

  /** Configure the main internal regulator output voltage
  */
  __HAL_RCC_PWR_CLK_ENABLE();
  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE1);
  /** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSE;
  RCC_OscInitStruct.HSEState = RCC_HSE_ON;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;
  RCC_OscInitStruct.PLL.PLLM = 4;
  RCC_OscInitStruct.PLL.PLLN = 180;
  RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV2;
  RCC_OscInitStruct.PLL.PLLQ = 2;
  RCC_OscInitStruct.PLL.PLLR = 2;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }
  /** Activate the Over-Drive mode
  */
  if (HAL_PWREx_EnableOverDrive() != HAL_OK)
  {
    Error_Handler();
  }
  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV4;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV2;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_5) != HAL_OK)
  {
    Error_Handler();
  }
}

/* USER CODE BEGIN 4 */
void processDSP() {
	HAL_ADC_Start_DMA(&hadc1, (uint32_t*)&volume, 1);
	for(unsigned int i=0; i<NS; i++) {
		outBufPtr[i] = (uint32_t)roundf(waveAmp*(float)inBufPtr[i]);
	}
}
/* USER CODE END 4 */

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */

/************************ (C) COPYRIGHT STMicroelectronics *****END OF FILE****/
